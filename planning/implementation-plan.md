# Implementation Plan

## 0 — Project Bootstrap
- [X] Step 0.1: Initialise Next 15 workspace
  - **Task**: `create-next-app@latest` with TypeScript, App Router, ESLint, Jest, Playwright.
  - **Files** (≤ 10):
    - `package.json`: add scripts (`dev`, `test`, `e2e`, `lint`).
    - `tsconfig.json`: strict mode.
  - **Step Dependencies**: none
  - **User Instructions**: run `pnpm dlx create-next-app curate --ts --eslint --app`.

- [X] Step 0.2: Tailwind & shadcn/ui setup
  - **Task**: add Tailwind, postcss, autoprefixer; initialise shadcn with default config.
  - **Files**:
    - `tailwind.config.ts`, `postcss.config.js`, `styles/tailwind.css`
    - `components/ui/**/*` (auto-generated by shadcn; < 20 files)
  - **Dependencies**: 0.1
  - **User Instructions**: `pnpm dlx shadcn-ui@latest init --tailwindcss`.

- [X] Step 0.3: Testing & linting baseline
  - **Task**: Configure Jest (RTL, jest-axe), Playwright, msw, eslint-plugin-testing-library.
  - **Files**:
    - `jest.config.ts`, `setupTests.ts`, `playwright.config.ts`, `tests/example.spec.ts`
  - **Dependencies**: 0.1
  - **User Instructions**: install dev deps `jest @testing-library/react jest-axe playwright msw`.

## 1 — Core Utilities & Types
- [X] Step 1.1: Define shared types & constants
  - **Task**: Add `types/drive.ts` for `FileMeta`, token caps, oversize limit, MIME constants.
  - **Files**:
    - `src/types/drive.ts`
  - **Dependencies**: 0.3

- [X] Step 1.2: Google Drive wrapper
  - **Task**: Implement `lib/drive.ts` with typed `listFiles`, `getFileStream`, exponential back-off util.
  - **Files**:
    - `src/lib/drive.ts`
  - **Dependencies**: 1.1
  - **User Instructions**: set `NEXT_PUBLIC_GOOGLE_API_KEY` and export `DRIVE_ACCESS_TOKEN` in shell for local dev.

- [X] Step 1.3: Tokenizer bootstrap
  - **Task**: Create `lib/tokenizer.ts` that spins up a Shared/Web Worker loading WASM `tiktoken`.
  - **Files**:
    - `src/lib/tokenizer.ts`
    - `src/workers/tokenizer.worker.ts`
  - **Dependencies**: 1.1

## 2 — Server Actions & API Routes
- [X] Step 2.1: scanFolder server action
  - **Task**: `/api/drive/scan` endpoint calling `lib/drive.listFiles` recursively with stream response.
  - **Files**:
    - `src/server/actions/scanFolder.ts`
    - `src/pages/api/drive/scan.ts`
  - **Dependencies**: 1.2

- [X] Step 2.2: extractFile server action
  - **Task**: `/api/drive/extract` streaming DOCX (mammoth) or PDF (pdfjs-dist) plain text.
  - **Files**:
    - `src/lib/extract.ts`
    - `src/server/actions/extractFile.ts`
    - `src/pages/api/drive/extract.ts`
  - **Dependencies**: 2.1
  - **User Instructions**: `pnpm add mammoth pdfjs-dist`

- [X] Step 2.3: tokenizeText & generateSnippet actions
  - **Task**: `/api/drive/tokenize` POST to worker, `/api/snippet/generate` formatter util.
  - **Files**:
    - `src/server/actions/tokenizeText.ts`
    - `src/server/actions/generateSnippet.ts`
    - `src/pages/api/drive/tokenize.ts`
    - `src/pages/api/snippet/generate.ts`
    - `src/lib/snippet.ts`
  - **Dependencies**: 1.3, 2.2

## 3 — Root Layout & Global UX
- [X] Step 3.1: Theme loader & n-progress
  - **Task**: Implement `app/layout.tsx` with `<html data-theme>` toggle, light/dark stored in localStorage; integrate `nextjs-progressbar`.
  - **Files**:
    - `src/app/layout.tsx`
    - `src/hooks/useTheme.ts`
  - **Dependencies**: 0.2

- [X] Step 3.2: Toast provider & icon sprites
  - **Task**: Add global Toast (`sonner` or shadcn/toast) and Sprite component with DOCX/PDF/alert icons.
  - **Files**:
    - `src/components/ToastProvider.tsx`
    - `src/components/Icon.tsx`
  - **Dependencies**: 3.1

## 4 — Folder Picking & Initial Scan
- [ ] Step 4.1: Google Picker component
  - **Task**: `components/DrivePicker.tsx` loads Picker SDK, returns selected folderId via prop callback.
  - **Files**:
    - `src/components/DrivePicker.tsx`
  - **Dependencies**: 3.2
  - **User Instructions**: enable Picker API in GCP.

- [ ] Step 4.2: /curate page skeleton
  - **Task**: `app/curate/page.tsx` – Suspense boundary, calls server action `scanFolder` and streams `FileMeta` into context atoms.
  - **Files**:
    - `src/app/curate/page.tsx`
    - `src/state/atoms.ts`
  - **Dependencies**: 4.1, 2.1

## 5 — FileTree & Selection Logic
- [ ] Step 5.1: Virtualised FileTree
  - **Task**: `components/FileTree/index.tsx` using `react-virtualized` list; checkboxes cascade, oversize badge logic.
  - **Files**:
    - `src/components/FileTree/FileTree.tsx`
    - `src/components/FileTree/Node.tsx`
  - **Dependencies**: 4.2, 1.1

- [ ] Step 5.2: Selection state & controls
  - **Task**: Add top-bar actions (Select All, Clear All, Sort, Search debounce).
  - **Files**:
    - `src/components/FileTree/Controls.tsx`
  - **Dependencies**: 5.1

## 6 — Preview & Extraction Flow
- [ ] Step 6.1: PreviewPane component
  - **Task**: `components/PreviewPane.tsx` fetches first 8 kB via `/api/drive/extract`; "Show more" progressive load.
  - **Files**:
    - `src/components/PreviewPane.tsx`
  - **Dependencies**: 2.2, 5.1

- [ ] Step 6.2: Error handling toasts
  - **Task**: corrupt DOCX/PDF, 0-text detection, display grey badge + tooltip.
  - **Files**:
    - Update `lib/extract.ts` (+1), `FileTree/Node.tsx` (+1)
  - **Dependencies**: 6.1

## 7 — Token Accounting
- [ ] Step 7.1: WebWorker integration
  - **Task**: Hook FileTree extraction streams into `tokenizer.worker`, store counts in Recoil `tokenState`.
  - **Files**:
    - `src/hooks/useTokenizer.ts`
  - **Dependencies**: 1.3, 6.1

- [ ] Step 7.2: TokenMeter UI
  - **Task**: `components/TokenMeter.tsx` fixed sidebar, soft warn @ 750 k, hard cap @ 1 M. Selecting breaching file triggers toast + prevent.
  - **Files**:
    - `src/components/TokenMeter.tsx`
  - **Dependencies**: 7.1

## 8 — Snippet Generation & Clipboard
- [ ] Step 8.1: Snippet formatter util
  - **Task**: implement whitespace stripping, filename headers, custom instructions append.
  - **Files**:
    - update `src/lib/snippet.ts`
  - **Dependencies**: 2.3

- [ ] Step 8.2: SnippetModal + copy button
  - **Task**: modal shows code-fenced markdown, "Copy to clipboard" writes text; disables if > 16 MB.
  - **Files**:
    - `src/components/SnippetModal.tsx`
  - **Dependencies**: 8.1, 7.2

## 9 — Persistence & Reset
- [ ] Step 9.1: LocalStorage persistence
  - **Task**: persist theme, sort order, expanded nodes; hook into Recoil effects.
  - **Files**:
    - `src/state/persistence.ts`
  - **Dependencies**: 5.2, 3.1

- [ ] Step 9.2: Reset action
  - **Task**: "Reset" button clears localStorage, Recoil state, and triggers sign-out redirect.
  - **Files**:
    - `src/components/ResetButton.tsx`
  - **Dependencies**: 9.1

## 10 — Styling & Polish
- [ ] Step 10.1: Icons, badges, progress bar
  - **Task**: finalise DOCX/PDF icons, oversize red badge, grey image-only badge, n-progress hook for async ops.
  - **Files**:
    - `src/components/Icon.tsx` (+), `styles/tokens.css`
  - **Dependencies**: 6.2, 3.1

- [ ] Step 10.2: Responsive & a11y tune-up
  - **Task**: keyboard nav in FileTree, ARIA labels, jest-axe compliance.
  - **Files**:
    - `FileTree/*.tsx` (+3), `tests/a11y.spec.ts`
  - **Dependencies**: 5.1, 6.1

## 11 — Testing Suite
- [ ] Step 11.1: Unit tests
  - **Task**: Jest tests for tokenizer counts, oversize badge, snippet formatter.
  - **Files**:
    - `tests/unit/tokenizer.test.ts`
    - `tests/unit/snippet.test.ts`
  - **Dependencies**: 7.1, 8.1

- [ ] Step 11.2: Integration tests
  - **Task**: msw mocks for Drive API; test scanFolder pagination + retry.
  - **Files**:
    - `tests/integration/scanFolder.test.ts`
  - **Dependencies**: 2.1

- [ ] Step 11.3: e2e flow
  - **Task**: Playwright script: pick demo folder → select files → generate snippet → verify clipboard.
  - **Files**:
    - `tests/e2e/curate.spec.ts`
  - **Dependencies**: 8.2

## 12 — CI & Deployment
- [ ] Step 12.1: GitHub Actions workflow
  - **Task**: on push PR → lint, unit, integration, e2e headless; upload coverage.
  - **Files**:
    - `.github/workflows/ci.yml`
  - **Dependencies**: 11.3
  - **User Instructions**: add `GOOGLE_API_KEY` and dummy `DRIVE_ACCESS_TOKEN` secrets in repo settings.

- [ ] Step 12.2: Vercel edge-runtime config
  - **Task**: `vercel.json` routes forcing HTTPS, edge-runtime for APIs, CSP headers.
  - **Files**:
    - `vercel.json`
  - **Dependencies**: 12.1
  - **User Instructions**: in Vercel dashboard set `GOOGLE_API_KEY` & production token env vars.

## 13 — Optional Enhancements
- [ ] Step 13.1: Download snippet as .txt
  - **Task**: generate Blob and trigger anchor download.
  - **Files**:
    - `SnippetModal.tsx` (+)
  - **Dependencies**: 8.2

- [ ] Step 13.2: Token breakdown CSV export
  - **Task**: compile per-file token counts → CSV download.
  - **Files**:
    - `components/TokenBreakdown.tsx`
  - **Dependencies**: 7.2
